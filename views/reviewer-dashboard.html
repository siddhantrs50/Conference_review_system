<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviewer Dashboard | Conference Review System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 text-gray-900 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-gradient-to-b from-blue-800 to-blue-900 text-white min-h-screen p-6">
    <h2 class="text-2xl font-bold mb-10">Dashboard</h2>

    <nav class="flex flex-col space-y-4">
      <button onclick="showSection('reviewed')" class="text-left px-4 py-2 bg-blue-700 rounded hover:bg-blue-600">Reviewed Papers</button>
      <button onclick="showSection('new')" class="text-left px-4 py-2 bg-blue-700 rounded hover:bg-blue-600">New Papers</button>
      <button onclick="showSection('profile')" class="text-left px-4 py-2 bg-blue-700 rounded hover:bg-blue-600">Profile</button>
      <button id="logoutBtn" class="text-left mt-10 px-4 py-2 bg-red-600 rounded hover:bg-red-500">Logout</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 space-y-6">
    <h1 class="text-3xl font-bold mb-6">Reviewer Dashboard</h1>

    <!-- Reviewed Papers Section -->
    <section id="reviewedSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">Reviewed Papers</h2>
      <ul id="reviewedPapers" class="space-y-4"></ul>
    </section>

    <!-- New Papers Section -->
    <section id="newSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">New Papers</h2>
      <ul id="newPapers" class="space-y-4"></ul>
    </section>

    <!-- Profile Section -->
    <section id="profileSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">Profile</h2>
      <div class="bg-white p-6 rounded shadow-md space-y-4 text-gray-800">
        <p><strong>Name:</strong> <span id="reviewerName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="reviewerEmail">Loading...</span></p>
        <p><strong>Role:</strong> Reviewer</p>
      </div>
    </section>

  </main>

  <script>
    const reviewerToken = localStorage.getItem('reviewerToken');

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('reviewerToken');
      window.location.href = 'reviewer-login.html';
    });

    // Section switching logic
    function showSection(section) {
      document.getElementById('reviewedSection').classList.add('hidden');
      document.getElementById('newSection').classList.add('hidden');
      document.getElementById('profileSection').classList.add('hidden');

      if (section === 'reviewed') {
        document.getElementById('reviewedSection').classList.remove('hidden');
        fetchReviewedPapers();
      } else if (section === 'new') {
        document.getElementById('newSection').classList.remove('hidden');
        fetchNewPapers();
      } else if (section === 'profile') {
        document.getElementById('profileSection').classList.remove('hidden');
        fetchProfile();
      }
    }

    // Fetch reviewed papers
    async function fetchReviewedPapers() {
      const reviewedPapersList = document.getElementById('reviewedPapers');
      reviewedPapersList.innerHTML = 'Loading...';

      try {
        const res = await fetch('http://localhost:3000/reviewer-reviewed-papers', {
          headers: { 'Authorization': `Bearer ${reviewerToken}` }
        });

        const papers = await res.json();

        reviewedPapersList.innerHTML = '';

        if (papers.length === 0) {
          reviewedPapersList.innerHTML = '<p>No papers reviewed yet.</p>';
          return;
        }

        papers.forEach(paper => {
            
          reviewedPapersList.innerHTML += `
            <li class="bg-white p-4 rounded shadow">
              <h3 class="text-lg font-bold">${paper.title}</h3>
              <p><strong>Score:</strong> ${paper.score}</p>
              <p><strong>Status:</strong> ${paper.status}</p>
              <p><strong>Your Review:</strong> ${paper.comments}</p>
            </li>
          `;
        });

      } catch (err) {
        console.error(err);
        reviewedPapersList.innerHTML = '<p>Error fetching reviewed papers.</p>';
      }
    }

    // Fetch new (unreviewed) papers
    async function fetchNewPapers() {
      const newPapersList = document.getElementById('newPapers');
      newPapersList.innerHTML = 'Loading...';

      try {
        const res = await fetch('http://localhost:3000/reviewer-unreviewed-papers', {
          headers: { 'Authorization': `Bearer ${reviewerToken}` }
        });

        const papers = await res.json();

        newPapersList.innerHTML = '';

        if (papers.length === 0) {
          newPapersList.innerHTML = '<p>No new papers to review.</p>';
          return;
        }

        papers.forEach(paper => {
            console.log(paper);
          newPapersList.innerHTML += `
            <li class="bg-white p-4 rounded shadow">
              <h3 class="text-lg font-bold cursor-pointer text-blue-600 hover:underline" onclick="openReviewForm(${paper.id}, '${paper.title}', '${paper.abstract}', '${paper.filename}')">
                ${paper.title}
              </h3>
            </li>
          `;
        });

      } catch (err) {
        console.error(err);
        newPapersList.innerHTML = '<p>Error fetching new papers.</p>';
      }
    }

    // Review form modal (basic inline for now)
    function openReviewForm(paperId, title, abstract, filename) {
      const container = document.createElement('div');
      container.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center";
      container.innerHTML = `
        <div class="bg-white p-8 rounded shadow max-w-lg w-full relative">
          <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✖️</button>
          <h2 class="text-2xl font-semibold mb-4">Review: ${title}</h2>
          
          <a href="http://localhost:3000/uploads/${filename}" target="_blank" class="text-blue-600 underline mb-4 block">Download Paper</a>
          
          <textarea id="review-${paperId}" class="w-full border rounded px-4 py-2 mb-4" placeholder="Write your review"></textarea>
          <select id="score-${paperId}" class="w-full border rounded px-4 py-2 mb-4">
            <option value="">Select a score</option>
            <option value="1">1 - Poor</option>
            <option value="2">2 - Fair</option>
            <option value="3">3 - Good</option>
            <option value="4">4 - Very Good</option>
            <option value="5">5 - Excellent</option>
          </select>
          <select id="status-${paperId}" class="w-full border rounded px-4 py-2 mb-4">
            <option value="">Select status</option>
            <option value="Pending">Pending</option>
            <option value="Accepted">Accepted</option>
            <option value="Rejected">Rejected</option>
          </select>
          
          <button onclick="submitReview(${paperId}); this.closest('.fixed').remove();" class="w-full bg-green-600 text-white py-2 rounded">Submit Review</button>
        </div>
      `;
      document.body.appendChild(container);
    }

    // Submit review
    async function submitReview(paperId) {
      const reviewText = document.getElementById(`review-${paperId}`).value.trim();
      const score = document.getElementById(`score-${paperId}`).value;
      const status = document.getElementById(`status-${paperId}`).value;

      if (!reviewText || !score || !status) {
        alert('Please fill in all review fields.');
        return;
      }

      try {
        const res = await fetch('http://localhost:3000/submit-review', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${reviewerToken}`
          },
          body: JSON.stringify({
            paperId,
            reviewText,
            score: parseInt(score),
            status
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert('Review submitted successfully!');
          fetchNewPapers(); // refresh list
        } else {
          alert(data.error || 'Error submitting review.');
        }

      } catch (err) {
        console.error(err);
        alert('Failed to submit review.');
      }
    }

    // Fetch reviewer profile
    async function fetchProfile() {
      try {
        const res = await fetch('http://localhost:3000/reviewer-profile', {
          headers: { 'Authorization': `Bearer ${reviewerToken}` }
        });

        const data = await res.json();

        document.getElementById('reviewerName').innerText = data.name;
        document.getElementById('reviewerEmail').innerText = data.email;

      } catch (err) {
        console.error(err);
        alert('Failed to fetch profile info.');
      }
    }

    // Load default section
    showSection('reviewed');

  </script>

</body>

</html>
